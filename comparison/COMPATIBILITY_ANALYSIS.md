# Compatibility Analysis: displaywidth, go-runewidth, and uniseg

> **Generated by:** Cursor IDE using Claude Sonnet 4.5 (Anthropic), with a few edits by me (@clipperhouse)

## Summary

This document summarizes the compatibility findings between three Go libraries for Unicode string width calculation:

- [clipperhouse/displaywidth](https://github.com/clipperhouse/displaywidth) (this package)
- [mattn/go-runewidth](https://github.com/mattn/go-runewidth)
- [rivo/uniseg](https://github.com/rivo/uniseg)

### 1. Regional Indicator Pairs (Flags)

Regional indicator pairs (flags like üá∫üá∏) are composed of two Regional Indicator symbols. Should they be treated as width 1 (like a single character) or width 2 (like a wide emoji)?

| Library | Default Behavior | With StrictEmojiNeutral=false |
|--------|------------------|-------------------------------|
| **displaywidth** | Width 2 per flag | Width 1 per flag |
| **go-runewidth** | Width 1 per flag | Width 1 per flag (setting has no effect) |
| **uniseg** | Width 2 per flag | Width 2 per flag (no such setting) |

**Understanding StrictEmojiNeutral:**
- **In displaywidth:**
  - Affects regional indicator pairs (flags): width 2 when true (default), width 1 when false
  - Affects East Asian Ambiguous + Emoji characters (when `EastAsianWidth=true`): width 2 when false
  - Does NOT affect regular emojis (always width 2) or keycap sequences (always width 2)
- **In go-runewidth:**
  - Has NO effect on flags (always width 1) or regular emojis (always width 2)
  - Affects characters in ambiguous+emoji+narrow tables (when `EastAsianWidth=true`): width 2 when false
  - This interaction is complex and rarely used in practice
- The name is confusing: "strict" means strictly applying emoji width rules, not being strict about neutrality

**Example:** `üá∫üá∏üáØüáµüá¨üáß` (3 flags)
- displaywidth default (StrictEmojiNeutral=true): 6 columns (2+2+2)
- displaywidth with StrictEmojiNeutral=false: 3 columns (1+1+1)
- go-runewidth (any setting): 3 columns (1+1+1)
- uniseg: 6 columns (2+2+2)

### 2. Variation Selectors - Minor Differences

**Variation selectors (VS15, VS16) affect emoji presentation:**

| Library | Behavior |
|---------|----------|
| **displaywidth** | Treats variation selectors as part of emoji (width 2) |
| **go-runewidth** | Treats variation selectors as separate characters (width 1 each) |
| **uniseg** | Treats variation selectors as part of emoji (width 2) |

**Example:** `‚ò∫Ô∏è‚åõÔ∏é‚ù§Ô∏è` (3 emoji with variation selectors)
- displaywidth: 5 columns
- go-runewidth: 4 columns
- uniseg: 5 columns

### 3. Keycap Sequences

**Keycap sequences (digit/symbol + VS16 + combining enclosing keycap):**

Keycap sequences like 1Ô∏è‚É£ are formed by: base character + variation selector (U+FE0F) + combining enclosing keycap (U+20E3).

| Library | Behavior | Width per Keycap |
|---------|----------|------------------|
| **displaywidth** | Treats as single wide emoji | 2 columns |
| **go-runewidth** | Treats base character only | 1 column |
| **uniseg** | Treats as single narrow character | 1 column |

**Example:** `1Ô∏è‚É£#Ô∏è‚É£` (2 keycap sequences)
- displaywidth: 4 columns (2 per keycap)
- go-runewidth: 2 columns (1 per keycap)
- uniseg: 2 columns (1 per keycap)

**Analysis:** displaywidth treats keycap sequences as wide emoji (width 2), while both go-runewidth and uniseg treat them as narrow (width 1).

### 4. East Asian Ambiguous Width - Configurable Difference

**East Asian Ambiguous characters** (‚òÖ, ¬∞, ¬±, etc.) can be rendered as either narrow (1 column) or wide (2 columns) depending on context.

| Library | Default | With EastAsianWidth=true |
|---------|---------|--------------------------|
| **displaywidth** | Width 1 | Width 2 |
| **go-runewidth** | Width 1 | Width 2 |
| **uniseg** | Width 1 | Width 2 (usually) |

**Example:** `‚òÖ¬∞¬±` (3 ambiguous characters)
- displaywidth default: 3 columns
- displaywidth with EastAsianWidth=true: 6 columns
- go-runewidth default: 3 columns
- go-runewidth with EastAsianWidth=true: 6 columns
- uniseg default: 3 columns
- uniseg with EastAsianAmbiguousWidth=2: 5 columns (usually)

### 5. Regular Emojis

**Regular emojis (üòÄ, üöÄ, üéâ, etc.) behave identically:**

| Library | Regular Emoji Width | Affected by StrictEmojiNeutral? |
|---------|---------------------|--------------------------------|
| **displaywidth** | Always 2 | ‚ùå No |
| **go-runewidth** | Always 2 | ‚ùå No |
| **uniseg** | Always 2 | N/A (no such setting) |

**Key Finding:** Regular emojis are ALWAYS width 2 in all libraries, regardless of any settings. The `StrictEmojiNeutral` option does NOT affect regular emoji width.

### 6. Basic Unicode Categories

Most Unicode categories show good compatibility.

| Category | displaywidth | go-runewidth | uniseg |
|----------|--------------|--------------|---------|
| ASCII | ‚úÖ Compatible | ‚úÖ Compatible | ‚úÖ Compatible |
| Latin Extended | ‚úÖ Compatible | ‚úÖ Compatible | ‚úÖ Compatible |
| CJK (Chinese/Japanese/Korean) | ‚úÖ Compatible | ‚úÖ Compatible | ‚úÖ Compatible |
| Arabic | ‚úÖ Compatible | ‚úÖ Compatible | ‚úÖ Compatible |
| Combining Marks | ‚úÖ Compatible | ‚úÖ Compatible | ‚úÖ Compatible |
| Zero-Width Characters | ‚úÖ Compatible | ‚úÖ Compatible | ‚úÖ Compatible |

## Detailed Test Results

> Run `go test -v -run TestStrictEmojiNeutral` in the `comparison/` directory to see comprehensive behavior comparisons between libraries.

### Test Case: "Hello ‰∏ñÁïå! üòÄüá∫üá∏"

**Breakdown:**
- "Hello " = 6 columns (ASCII)
- "‰∏ñÁïå" = 4 columns (CJK, 2 each)
- "! " = 2 columns (ASCII)
- "üòÄ" = 2 columns (emoji)
- "üá∫üá∏" = 1-2 columns (flag, depends on library)

**Results:**
- displaywidth default: 16 columns
- displaywidth with StrictEmojiNeutral=false: 15 columns
- go-runewidth: 15 columns
- uniseg: 16 columns

### Test Case: "üöÄüöÄüöÄ" (3 rocket emoji)

**Results:**
- displaywidth: 6 columns (2 per emoji)
- go-runewidth: 6 columns (2 per emoji)
- uniseg: 6 columns (2 per emoji)

### Test Case: "üöÄüöÄüöÄ" (3 rocket emoji with StrictEmojiNeutral=false)

**Results:**
- displaywidth: 6 columns (2 per emoji, setting doesn't affect regular emoji)
- go-runewidth: 6 columns (2 per emoji, setting doesn't affect regular emoji)
- uniseg: 6 columns (2 per emoji)


## Compatibility Recommendations

### 1. For displaywidth Users

**Default Behavior (StrictEmojiNeutral=true):**
- ‚úÖ Compatible with uniseg for flags (both use width 2)
- ‚ùå Incompatible with go-runewidth for flags (displaywidth: 2, go-runewidth: 1)
- ‚ùå Incompatible with both for keycap sequences (displaywidth: 2, others: 1)
- ‚úÖ Compatible with both for basic Unicode categories

**With StrictEmojiNeutral=false:**
- ‚úÖ Compatible with go-runewidth for flags (both use width 1)
- ‚ùå Incompatible with uniseg for flags (displaywidth: 1, uniseg: 2)
- ‚ùå Incompatible with both for keycap sequences (displaywidth: 2, others: 1)
- ‚úÖ Compatible with both for basic Unicode categories

**Key Insights:**
- **In displaywidth:** `StrictEmojiNeutral` affects:
  - Regional indicator pairs (flags): width 2 when true, width 1 when false
  - Characters that are both East Asian Ambiguous AND Emoji (when `EastAsianWidth=true`): width 2 when false
  - Does NOT affect regular emojis or keycap sequences
- **In go-runewidth:** `StrictEmojiNeutral` affects:
  - Characters in ambiguous, emoji, and narrow tables (when `EastAsianWidth=true`): width 2 when false
  - Does NOT affect flags (always width 1) or regular emojis (always width 2)
- Regular emojis (üòÄ, üöÄ, üéâ) are **always width 2** in both libraries, regardless of the setting
- Keycap sequences are always width 2 in displaywidth, always width 1 in go-runewidth

### 2. Migration Strategies

**From go-runewidth to displaywidth:**
- Use `StrictEmojiNeutral=false` for flag compatibility (1 column per flag)
- ‚ö†Ô∏è Keycap sequences will change from width 1 to width 2 (breaking change)
- ‚ö†Ô∏è Some variation selector sequences may differ slightly

**From uniseg to displaywidth:**
- Use default settings (StrictEmojiNeutral=true) for flag compatibility (2 columns per flag)
- ‚ö†Ô∏è Keycap sequences will change from width 1 to width 2 (breaking change)
- Most other emoji should behave identically

### 3. Use Case Considerations

**Terminal Applications:**
- displaywidth with StrictEmojiNeutral=false is most compatible with go-runewidth
- Good for applications migrating from go-runewidth

**Modern Unicode Applications:**
- displaywidth with default settings is most compatible with uniseg
- Better for applications that need strict Unicode compliance

**Cross-Platform Compatibility:**
- Consider using displaywidth with StrictEmojiNeutral=false for maximum compatibility
- Test thoroughly with your specific use cases

## Which Library is "Correct"?

This is a nuanced question because Unicode standards don't always provide definitive answers for display width in monospace contexts.

### Regional Indicator Pairs (Flags)

**The Unicode Standard doesn't specify display width for flags.** Different interpretations exist:

- **Width 2 (displaywidth default, uniseg):** Flags are emoji and should occupy 2 columns like other emoji
- **Width 1 (go-runewidth, displaywidth with StrictEmojiNeutral=false):** Flags are a single grapheme cluster and should occupy 1 column

**Terminal behavior varies:** Some terminals render flags as width 2, others as width 1. There's no universal standard.

### Keycap Sequences

**displaywidth treats keycaps as width 2, while go-runewidth and uniseg treat them as width 1.**

- Most modern terminals render keycaps (1Ô∏è‚É£, #Ô∏è‚É£) as emoji-width characters (2 columns)
- However, older terminals may render them as narrow characters (1 column)
- displaywidth's approach (width 2) aligns better with modern terminal behavior

### Variation Selectors

**displaywidth and uniseg handle variation selectors more correctly:**

- VS16 (U+FE0F) requests emoji presentation ‚Üí should be width 2
- VS15 (U+FE0E) requests text presentation ‚Üí should be width 1
- go-runewidth treats variation selectors as separate characters, which may be less accurate

### wcwidth Compatibility

The POSIX `wcwidth()` function is the traditional C library function for determining character width. However:

- **wcwidth is locale-dependent** and may not handle modern emoji correctly
- **wcwidth predates most emoji** and doesn't have consistent behavior for flags or keycaps
- Most Go libraries (including displaywidth, go-runewidth, and uniseg) provide more modern, Unicode-aware implementations
- displaywidth's behavior is generally more aligned with modern Unicode standards than legacy wcwidth

### Recommendation

**For modern applications:**
- displaywidth with default settings provides the most accurate behavior for modern terminals
- Keycaps and emoji are correctly treated as wide characters
- Better Unicode compliance than legacy wcwidth

**For legacy compatibility:**
- displaywidth with `StrictEmojiNeutral=false` matches go-runewidth behavior
- Better for applications that need to match existing go-runewidth deployments
- Still more accurate than wcwidth for emoji handling

## Conclusion

The compatibility analysis reveals that while the three libraries are generally compatible for basic Unicode categories, they differ significantly in their handling of:

1. **Regional indicator pairs (flags)** - The biggest compatibility issue
   - displaywidth default: width 2 (matches uniseg)
   - displaywidth with StrictEmojiNeutral=false: width 1 (matches go-runewidth)
   - Configurable via `StrictEmojiNeutral` option

2. **Keycap sequences** - displaywidth treats as width 2, others as width 1
   - This is NOT configurable and represents a fundamental difference
   - displaywidth's approach aligns better with modern terminal rendering

3. **Variation selectors** - Minor differences in handling
   - displaywidth and uniseg handle VS15/VS16 more correctly
   - go-runewidth treats them as separate characters

4. **East Asian Ambiguous characters** - Generally compatible
   - All three libraries support EastAsianWidth configuration
   - uniseg shows some inconsistencies (5 columns instead of 6 for `‚òÖ¬∞¬±`)

### Key Strengths of displaywidth

1. **Flexibility:** The `StrictEmojiNeutral` option allows choosing between different flag behaviors
2. **Modern Unicode support:** Better handling of variation selectors and keycap sequences
3. **Performance:** Faster than both go-runewidth and uniseg in benchmarks
4. **Correctness:** More aligned with modern terminal behavior for emoji

### Recommendations by Use Case

**For new applications:**
- Use displaywidth with default settings for best modern terminal compatibility
- Expect flags and keycaps to occupy 2 columns each

**For go-runewidth migration:**
- Use displaywidth with `StrictEmojiNeutral=false` for flag compatibility
- ‚ö†Ô∏è Be aware that keycap sequences will change from width 1 to width 2

**For uniseg migration:**
- Use displaywidth with default settings
- ‚ö†Ô∏è Be aware that keycap sequences will change from width 1 to width 2

**For legacy wcwidth compatibility:**
- displaywidth provides better Unicode support than wcwidth
- Use `StrictEmojiNeutral=false` for more conservative behavior
- Test thoroughly as wcwidth behavior varies by locale and implementation
